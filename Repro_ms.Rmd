---
title: "| Ciencia reproducible: qué, por qué, cómo \n| Reproducible science: what,
  why, how\n"
  
author: Francisco Rodríguez-Sánchez^1^, Antonio Jesús Pérez-Luque^2^, Sara Varela^3^,
  Ignasi Bartomeus^1^ (*order to be determined*)
  
output:
  word_document:
    fig_caption: yes
    highlight: null
    reference_docx: Ecosistemas_template.docx

bibliography: references.bib
csl: american-journal-of-botany.csl
---

> (1) Departamento de Ecología Integrativa, Estación Biológica de Doñana (EBD-CSIC), Consejo Superior de Investigaciones Científicas, Avda. Américo Vespucio s/n, E-41092 Sevilla, España.

> (2) Laboratorio de Ecología (iEcolab), Instituto Interuniversitario Sistema Tierra (CEAMA), Universidad de Granada, Avda. del Mediterráneo s/n, Granada 18006, España.

> (3) Departamento de Ciencias de la Vida, Facultad de Biología, Ciencias Ambientales y Química, Universidad de Alcalá, Campus Universitario. Ctra. Madrid-Barcelona, Km. 33,600, 28805 Alcalá de Henares, Madrid, España.


> Autor para correspondencia: F. Rodríguez-Sánchez [frodriguez.work@gmail.com]



```{r knitr_setup, include=FALSE, cache=FALSE}
 
library(rmarkdown)
library(knitr)

### Chunk options ###

# Modify at your will #

## Text results
opts_chunk$set(echo = TRUE, warning=TRUE, message=TRUE)

## Code decoration
opts_chunk$set(tidy=TRUE, comment = NA, highlight = TRUE)

## Cache
opts_chunk$set(cache = 2, cache.path = "output/cache/")
opts_chunk$set(cache.extra = rand_seed)

## Plots
opts_chunk$set(fig.path = "output/figures/")
opts_chunk$set(dpi = 300, fig.align = "default")   # may want 'center' sometimes

# Figure format
opts_chunk$set(dev='png')  # e.g. choose among 'pdf', 'png', 'svg'...
# may include specific dev.args as a list... see knitr help


```


```{r citations_setup, include=FALSE, cache=FALSE}

library(knitcitations)
cleanbib()   
cite_options(citation_format = "pandoc")

if (file.exists("refs2import.bib")) 
  refs_from_file <- read.bibtex("refs2import.bib", check=FALSE)

```


# Resumen

> Bla, bla, bla

# Abstract

> Blah, blah, blah

# Palabras clave

> reproducibilidad; etc (4-6 keywords)


# Keywords

> reproducibility; etc (4-6 keywords)


# Introducción 

Un científico pasa semanas o meses intentando implementar un nuevo método de análisis publicado recientemente, a partir de la escueta descripción proporcionada en el artículo. Otro, extrañado por los resultados de un trabajo reciente, solicita a los autores los datos para reanalizarlos, pero los autores se niegan a compartir sus datos o los han perdido. Un jefe de grupo intenta repetir un análisis que publicó hace unos años con un nuevo dataset, pero el postdoc que se encargó de eso ya no está en el grupo y nadie más sabe o recuerda cómo hacerlo. En otro caso, un investigador es invitado a participar en un meta-análisis pero los datos necesarios se perdieron con el último ordenador, o se encuentran en un formato ilegible hoy día. Finalmente, un doctorando detecta, poco antes de enviar su manuscrito, un error en los datos, y tiene que emplear varios días (o semanas) para rehacer todos los análisis y actualizar todas las tablas y figuras del manuscrito, antes de poder enviarlo.

Todas estas escenas son desgraciadamente frecuentes en el día a día de los científicos, y son evidencia del grave problema de reproducibilidad en Ciencia. La inmensa mayoría de los artículos científicos no son reproducibles, esto es, es muy difícil o incluso imposible trazar claramente el proceso de obtención de los resultados y volver a obtenerlos (reproducirlos), !incluso tratándose del mismo equipo de autores! ?Cuántas veces hemos querido revisitar un análisis hecho unos meses o años antes y no hemos sido capaces, bien porque los datos no están disponibles o no recordamos cómo hacerlo? Cuánto tiempo perdemos inútilmente en intentar reproducir algo (un análisis estadístico, una figura, una tabla) ya hecho previamente? [Bourne: 280 h] ?O en regenerar una figura tras corregir un error en los datos?

No podemos garantizar que ningún resultado/paper es correcto, pero sí reproducible [Peng]


# Qué es la ciencia reproducible?

Parrafo sobre Reproducibilidad vs "repetibilidad". http://bioscience.oxfordjournals.org/content/56/12/958.full

Parrafo ejemplos:
Ejemplos de papers 100% reproducibles: Fitzroy en Journal of ecology? 
Ejemplos datos publicos re-analizados: PNAS paper en huracanes.



# Por qué es necesaria la reproducibilidad en Ciencia?

Parrafo filosofico sobre por que la transparencia (reproducibilidad) ha de nacer de la uno mismo, y dar confianza, y no ha de ser impuesta por la desconfianza. Hemos de apelar a los cientificos, no a tener la obligación, sino el deso de hacer nuestro workflow reproducible.


Parrafo por que es bueno para ti, desde un punto estrategico y de posicionamiento. Das un sello de calidad a tu ciencia. Adoptarla ahora te pone por delante, Cuando sea un estandard, ya no tendra merito.
Por ejemplo, Molecular Ecology states that "Papers with exemplary data and code archiving are more valuable for future research, and, all else being equal, will be given higher priority for publication" (http://onlinelibrary.wiley.com/journal/10.1111/%28ISSN%291365-294X/homepage/ForAuthors.html)



# Cómo hacer Ciencia reproducible

La ciencia reproducible es dura

Parrafo sobre barreras para adoptar un flujo reproducible. Tornar las barreras en puntos positivos. Te fuerza a ser más limpio, ordenado, y seguro de tus resultados. Es duro, pero es bueno. 

Parrafo sobre estrategias para hacer el paso. No es cuestion de todo o nada. De hecho, intentar ser 100% reproducible de golpe lleva a frustración y abandono. Se trata de ganar batallas y empezar por las faciles. Quizas ejemplos de los propios autores.

K Broman guides are very good. Also paper Tao of open science (Ecosphere)

Esta sección está subdividida en subsecciones.


## Toma y Manejo de datos [NACHO]

No olvidemos que no todo empieza cuando abres rstudio (bueno, a veces sí). Toma de datos por observadores independientes, evitando o testando subjetividad (e.g. Winfree papers), Mantener el link entre datos fisicos y digitales. 


## Análisis (R) y escritura (Rmarkdown) [PACO]


## Control de versiones (git & github) [ANTONIO]
El *control de versiones* es un sistema que registra los cambios que se realizan sobre un archivo (o conjunto de archivos) a lo largo de la historia del mismo, permitiendo restarurar una versión específica del archivo en cualquier momento. 

El control de versiones está instalado en la vida de los científicos y lo utilizamos en una o varias etapas durante el desarrollo cualquier investigación. Una forma sencilla de llevar a cabo un control de versiones, y quizá la mas común, consiste en realizar duplicados de los archivos (o de los directorios) con nombres poco informativos de los cambios aplicados (Figura *phd_comics*). Esta aproximación es muy simple pero también muy propensa a cometer errores (e.g. modificar, sobrescribir el archivo incorrecto). 

#### De los sistemas de control de versiones locales a los distribuidos. 
Para evitar este tipo de errores surgieron los *sistemas de control de versiones locales* donde los cambios sobre los archivos se mantenían bajo control en una base de datos. Sin embargo estos sistemas locales no permitían la colaboración, para lo cual se desarrollaron los *sistemas de control de versiones centralizados*, que consisten un servidor que contiene todos los archivos versionados y varios clientes que descargan los archivos desde ese lugar central. Este sistema, aunque ha sido ampliamente utilizado (Subversion, Perforce) presenta algunas desventajas: no es posible colaborar o guardar cambios si el servidor central está caido; pérdida de información en caso de que se corrompan los discos duros que almacenan la información en el servidor central, etc. Es por ello que surgieron los sistemas de control de versiones distribuidos (como Git o Mercurial) donde los clientes no solo descargan la última instantantea del archivo sino que replican el repositorio completamente, de tal forma que se hace una copia de seguridad de todos los datos. 


## Paquetes en R [SARA]

Una vez iniciado un proyecto para el cual estamos programando distintos análisis en forma de diferentes scripts en R, el método óptimo para organizar el código que vayamos generando es crear un paquete de R. La principal razón para hacer esto es que cualquier otra manera de organizar nuestro código (e.g. creando una carpeta con subcarpetas dentro de nuestra carpeta principal con los archivos relacionados con el manuscrito en ciernes) se hará ingobernable a medida que pase el tiempo y que nuestro código se complique. 

Crear un paquete para reunir los scripts, la documentación de las funciones y los tests de las funciones, en contra de lo que pudiera parecer, no es un proceso difícil. Se trata de una estructura estándar en las cual las funciones van a funcionar (valga la redundancia), donde especificaremos las dependencias de nuestras funciones (qué otros paquetes estamos utilizando, y lo que también es muy importante, qué versiones de estos paquetes), además describiremos las funciones que hemos desarrollado y daremos ejemplos de uso para que un usuario externo (e incluso nosotros mismos en el futuro) pueda entender qué resultados va obtener y en qué formatos. 

De esta manera, un paquete de R es una estructura estándar que ayuda a entender nuestro código a usuarios externos (y a nosotros mismos), y que además es fácilmente compartible. De este modo estaremos facilitando el trabajo en equipo y el desarrollo de utilizades más complejas (que necesariamente requieren de un equipo de desarrolladores), usando además un programa de control de versiones (como GIT) y compartiendo el código en un repositorio público (como https://github.com).

Por todas estas razones, si queremos crear un proyecto de ciencia abierta y colaborativa en el cual programemos nuestras funciones en R, la manera óptima de hacerlo es creando un paquete de R a medida que vamos programando las funciones.

### Estructura estándar de un paquete de R

De manera general un paquete de R es una carpeta que debe tener al menos 3 subcarpetas (R, man y tests/testthat) y dos archivos de texto (DESCRIPTION y NAMESPACE) (e.g. https://github.com/ropensci/paleobioDB, leer Wickham 2015.R packages: organize, test, document and share your code, O'Reilly)

#### R

En esta carpeta será donde se guardan los archivos .R, osea, nuestros scripts de R. Cada función deberá llevar escrita su documentación inmediatamente encima de ella usando roxygen2 (https://cran.r-project.org/web/packages/roxygen2/vignettes/roxygen2.html) (para ver un ejemplo de una función real y su documentación escrita usando roxygen2 ver https://github.com/ropensci/paleobioDB/blob/master/R/pbdb_taxonomic_functions.R). Además tendremos que crear un archivo .R que se llame myfirstpackage-package.R, y en el cual expliquemos qué hace y como funciona nuestro paquete y que estará escrito en roxygen2 (https://github.com/ropensci/paleobioDB/blob/master/R/paleobioDB-package.R).

#### man

En esta carpeta se guardarán los archivos .Rd, es decir, los archivos de ayuda que se abrirán cuando se use la función ? y que además forman el manual oficial del paquete en pdf. Estos archivos no se deben escribir a mano sino que se crean cuando se ejecuta el comando roxygenize, que lee la documentación que hemos generado previamente para cada función de R (https://github.com/ropensci/paleobioDB/tree/master/man)

#### Tests/testthat

Además, debemos incorporar tests para cada función para comprobar que las funciones realmente están haciendo lo que realmente queremos. Los test son scripts de R que comprueban cada función (son archivos .R, ver https://cran.r-project.org/web/packages/testthat/testthat.pdf). Estos tests son fundamentales a la hora de mantener un paquete porque cuando los paquetes crecen y se hacen complejos las interdependencias entre funciones son menos evidentes, así que podríamos llegar a modificar una función sin darnos cuenta de que al hacerlo estamos rompiendo otra que depende de ella (y las razones pueden no ser evidentes a primera vista, e.g., cuestiones de formato de los datos). Para ver un ejemplo real de tests abrir: https://github.com/ropensci/paleobioDB/tree/master/tests/testthat.

#### DESCRIPTION

Es un archivo de texto en el cual se especifica el nombre del paquete, su versión, los autores, emails, las dependencias que tiene, etc. (ver https://github.com/ropensci/paleobioDB/blob/master/DESCRIPTION) (Nota: editar DESCRIPTION con RStudio, nunca con el block de notas).

#### NAMESPACE

Es un archivo de texto que se genera automáticamente al ejecutar el comando roxygenize en el cual se especifican los nombres de las funciones que estarán disponibles al cargar nuestro paquete, que serán nuestras funciones propias y las funciones que importemos o de las que dependamos. Si nuestro paquete tiene una función con el mismo nombre que otro que se haya cargado antes R genera un mensaje informando del problema (colisión de nombres). Para evitar colisiones de nombres puedes aplicar un prefijo a las funciones de tu paquete de forma que sus nombres no coincidan con los de ninguna otra función que haya sido programada en R.

#### Crear el paquete

Finalmente, después de haber ejecutado el comando roxygenize para generar los manuales y el NAMESPACE, podemos crear nuestro paquete ejecutando las siguientes líneas desde el símbolo del sistema o del bash:

```coffee
cd..
R CMD build --resave-data myfirstpackage
```

Si nuestro paquete pasa el check –as-cran sin ningún warning podríamos incluso compartirlo en el CRAN de R. 

```coffee
R CMD check --as-cran myfirstpackage_0.1.tar.gz
```


## Dependencias externas [PACO]

Si queremos que nuestro análisis sea reproducible en el futuro, tenemos que asegurarnos de que tenemos controladas todas las dependencias externas (paquetes, etc). Si no, actualizaciones de paquetes pueden romper el workflow (e.g. el libro de knitr ya no era reproducible meses después). Esbozar soluciones: rctrack, packrat, checkpoint, drat, rocker...










# Referencias

Or cite by doi, e.g. `r citet("10.1098/rspb.2013.1372")`, thanks to `knitcitations` package `r citep(citation("knitcitations"))`. 


# Tablas

Se aportarán los encabezamientos tanto en castellano como en inglés, en letra Arial 10 y en página independiente.



# Pies de figura

Página independiente. En castellano e inglés. Letra Arial 10.



# Figuras 

En páginas independientes

- [Peng Science 2011](http://www.ncbi.nlm.nih.gov/pmc/articles/PMC3383002/bin/nihms382015f1.jpg)
- [Broken workflow](http://pakillo.github.io/Rmarkdown_talk_SevillaR_Nov2014/#/5)
- [Git & version control](http://pakillo.github.io/Rmarkdown_talk_SevillaR_Nov2014/#/19)



# Mover esta lista de referencias a la sección de 'Referencias', más arriba en documento final (Word).

```{r generate_references, cache=FALSE, include=FALSE, results='hide'}
write.bibtex(file="references.bib")
```









